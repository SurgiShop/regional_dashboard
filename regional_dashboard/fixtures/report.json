[
  {
    "add_total_row": 0,
    "disabled": 0,
    "docstatus": 0,
    "doctype": "Report",
    "is_standard": "No",
    "module": "Selling",
    "name": "Regional Dashboard",
    "ref_doctype": "Sales Person",
    "report_name": "Regional Dashboard",
    "report_type": "Script Report",
    "roles": [
      {
        "role": "Sales User"
      },
      {
        "role": "Sales Manager"
      }
    ],
    "report_script": "import frappe\nfrom frappe import _\nfrom frappe.utils import flt\n\n\ndef execute(filters=None):\n    columns = get_columns()\n    data = get_data(filters)\n    if data is None:\n        data = []\n    return columns, data\n\n\ndef get_columns():\n    return [\n        {\n            \"fieldname\": \"sales_person\",\n            \"label\": _(\"REP\"),\n            \"fieldtype\": \"Link\",\n            \"options\": \"Sales Person\",\n            \"width\": 180,\n        },\n        {\n            \"fieldname\": \"total_sales\",\n            \"label\": _(\"Current Account Rev\"),\n            \"fieldtype\": \"Currency\",\n            \"width\": 150,\n        },\n        {\n            \"fieldname\": \"sales_goal\",\n            \"label\": _(\"Account Goal\"),\n            \"fieldtype\": \"Currency\",\n            \"width\": 130,\n        },\n        {\n            \"fieldname\": \"current_sil\",\n            \"label\": _(\"Current SIL\"),\n            \"fieldtype\": \"Currency\",\n            \"width\": 130,\n        },\n        {\n            \"fieldname\": \"sil_goal\",\n            \"label\": _(\"Goal SIL\"),\n            \"fieldtype\": \"Currency\",\n            \"width\": 130,\n        },\n        {\n            \"fieldname\": \"sales_goal_percent\",\n            \"label\": _(\"REV Goal\"),\n            \"fieldtype\": \"Data\",\n            \"width\": 120,\n        },\n        {\n            \"fieldname\": \"sil_goal_percent\",\n            \"label\": _(\"SIL Goal\"),\n            \"fieldtype\": \"Data\",\n            \"width\": 120,\n        },\n    ]\n\n\ndef get_data(filters):\n    if not filters:\n        filters = {}\n\n    sales_persons = frappe.get_all(\n        \"Sales Person\",\n        filters={\"enabled\": 1},\n        fields=[\"name\"],\n        order_by=\"name asc\",\n    )\n\n    if not sales_persons:\n        return []\n\n    data = []\n\n    for sp in sales_persons:\n        sales_person_name = sp.name\n\n        targets = frappe.db.sql(\n            \"\"\"\n            SELECT\n                SUM(CASE WHEN item_group = 'Products' THEN target_amount ELSE 0 END) as sales_goal,\n                SUM(CASE WHEN item_group = 'SIL' THEN target_amount ELSE 0 END) as sil_goal\n            FROM `tabTarget Detail`\n            WHERE parent = %(sales_person)s\n        \"\"\",\n            {\"sales_person\": sales_person_name},\n            as_dict=1,\n        )\n\n        sales_goal = flt(targets[0].sales_goal) if targets and targets[0].sales_goal else 0\n        sil_goal = flt(targets[0].sil_goal) if targets and targets[0].sil_goal else 0\n\n        total_sales = get_sales_for_person(sales_person_name, filters)\n        current_sil = get_sil_sales_for_person(sales_person_name, filters)\n\n        sales_goal_percent = (\n            f\"{round((flt(total_sales) / flt(sales_goal) * 100), 2)}%\" if sales_goal > 0 else \"0%\"\n        )\n        sil_goal_percent = (\n            f\"{round((flt(current_sil) / flt(sil_goal) * 100), 2)}%\" if sil_goal > 0 else \"0%\"\n        )\n\n        data.append(\n            {\n                \"sales_person\": sales_person_name,\n                \"total_sales\": total_sales,\n                \"sales_goal\": sales_goal,\n                \"current_sil\": current_sil,\n                \"sil_goal\": sil_goal,\n                \"sales_goal_percent\": sales_goal_percent,\n                \"sil_goal_percent\": sil_goal_percent,\n            }\n        )\n\n    return data\n\n\ndef get_sales_for_person(sales_person, filters):\n    conditions = []\n    values = {\"sales_person\": sales_person}\n\n    if filters.get(\"from_date\"):\n        conditions.append(\"si.posting_date >= %(from_date)s\")\n        values[\"from_date\"] = filters.get(\"from_date\")\n\n    if filters.get(\"to_date\"):\n        conditions.append(\"si.posting_date <= %(to_date)s\")\n        values[\"to_date\"] = filters.get(\"to_date\")\n\n    where_clause = \"\"\n    if conditions:\n        where_clause = \"AND \" + \" AND \".join(conditions)\n\n    result = frappe.db.sql(\n        f\"\"\"\n        SELECT SUM(si.grand_total) as total\n        FROM `tabSales Invoice` si\n        INNER JOIN `tabSales Team` st ON st.parent = si.name\n        WHERE si.docstatus = 1\n            AND st.sales_person = %(sales_person)s\n            {where_clause}\n    \"\"\",\n        values,\n        as_dict=1,\n    )\n\n    return flt(result[0].total) if result and result[0].total else 0\n\n\ndef get_sil_sales_for_person(sales_person, filters):\n    conditions = []\n    values = {\"sales_person\": sales_person}\n\n    if filters.get(\"from_date\"):\n        conditions.append(\"si.posting_date >= %(from_date)s\")\n        values[\"from_date\"] = filters.get(\"from_date\")\n\n    if filters.get(\"to_date\"):\n        conditions.append(\"si.posting_date <= %(to_date)s\")\n        values[\"to_date\"] = filters.get(\"to_date\")\n\n    where_clause = \"\"\n    if conditions:\n        where_clause = \"AND \" + \" AND \".join(conditions)\n\n    result = frappe.db.sql(\n        f\"\"\"\n        SELECT SUM(sii.amount) as total\n        FROM `tabSales Invoice` si\n        INNER JOIN `tabSales Team` st ON st.parent = si.name\n        INNER JOIN `tabSales Invoice Item` sii ON sii.parent = si.name\n        INNER JOIN `tabItem` item ON item.name = sii.item_code\n        WHERE si.docstatus = 1\n            AND st.sales_person = %(sales_person)s\n            AND item.item_group = 'SIL'\n            {where_clause}\n    \"\"\",\n        values,\n        as_dict=1,\n    )\n\n    return flt(result[0].total) if result and result[0].total else 0\n"
  }
]


